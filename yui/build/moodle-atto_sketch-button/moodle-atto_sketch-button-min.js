YUI.add("moodle-atto_sketch-button",function(e,t){var o=/\d+%/,i=M.cfg.wwwroot+"/lib/editor/atto/plugins/sketch/sketch.html",n="sketchpad",a={INPUTSUBMIT:"atto_sketch_submit",HGT:"height: calc(100vh - 110px);",WDT:"width: 100%;"};e.namespace("M.atto_sketch").Button=e.Base.create("button",e.M.editor_atto.EditorPlugin,[],{initializer:function(){if(this.get("host").canShowFilepicker("media")||!(this.get("storeinrepo")>0)){this.addButton({icon:"ed/iconone",iconComponent:"atto_sketch",buttonName:"iconone",callback:this._displayDialogue,callbackArgs:"iconone",tags:"img",tagMatchRequiresAll:!1})}},_convertImage:function(e){var t;t=e.split(",")[0].indexOf("base64")>=0?atob(e.split(",")[1]):decodeURI(e.split(",")[1]);for(var o=e.split(",")[0].split(":")[1].split(";")[0],i=new Uint8Array(t.length),n=0;n<t.length;n++)i[n]=t.charCodeAt(n);return new Blob([i],{type:o})},_doInsert:function(t){var o=this,i=this.get("host"),a=e.Handlebars.compile('<img src="{{url}}" alt="{{alt}}" {{#if width}}width="{{width}}" {{/if}}{{#if height}}height="{{height}}" {{/if}}{{#if presentation}}role="presentation" {{/if}}{{#if customstyle}}style="{{customstyle}}" {{/if}}{{#if classlist}}class="{{classlist}}" {{/if}}{{#if id}}id="{{id}}" {{/if}}/>');i.saveSelection(),t=t._event;var s=$("#"+n).contents(),d=(s.find("#selection"),this._convertImage(s[0].getElementById("canvas_minipaint").toDataURL()));if(d&&d.size&&"image/png"==d.type){var l,r,c,u=i.get("filepickeroptions").image,g=void 0===u.savepath?"/":u.savepath,h=new FormData,m=new XMLHttpRequest,p=Object.keys(u.repositories);t.preventDefault(),t.stopPropagation(),h.append("repo_upload_file",d),h.append("itemid",u.itemid);for(var f=0;f<p.length;f++)if("upload"===u.repositories[p[f]].type){h.append("repo_id",u.repositories[p[f]].id);break}return h.append("env",u.env),h.append("sesskey",M.cfg.sesskey),h.append("client_id",u.client_id),h.append("savepath",g),h.append("ctx_id",u.context.id),l=(new Date).getTime(),r="moodleimage_"+Math.round(1e5*Math.random())+"-"+l,o.getDialogue({focusAfterHide:null}).hide(),i.focus(),i.restoreSelection(),c=a({url:M.util.image_url("i/loading_small","moodle"),alt:M.util.get_string("uploading","atto_sketch"),id:r}),i.insertContentAtFocusPoint(c),o.markUpdated(),m.onreadystatechange=function(){var t,i,n,s,d=o.editor.one("#"+r);if(4===m.readyState)if(200===m.status){if(t=JSON.parse(m.responseText)){if(t.error&&d)d.remove(!0);else if(t.error)return new M.core.ajaxException(t);i=t,t.event&&"fileexists"===t.event&&(i=t.newfile),n=a({url:i.url,presentation:!0}),s=e.Node.create(n),d?d.replace(s):o.editor.appendChild(s),o.markUpdated()}}else e.use("moodle-core-notification-alert",function(){new M.core.alert({message:M.util.get_string("servererror","moodle")})}),d&&d.remove(!0);return!0},m.open("POST",M.cfg.wwwroot+"/repository/repository_ajax.php?action=upload",!0),m.send(h),!0}return!0},_getSelectedImageProperties:function(){var e,t,i={src:null,alt:null,width:null,height:null},n=this.get("host").getSelectedNodes();return n&&(n=n.filter("img")),n&&n.size()?(this._selectedImage=n.item(0),(e=this._selectedImage.get("width")).toString().match(o)||(e=parseInt(e.toString(),10)),(t=this._selectedImage.get("height")).toString().match(o)||(t=parseInt(t.toString(),10)),0!==e&&(i.width=e),0!==t&&(i.height=t),i.src=this._selectedImage.get("currentSrc"),i.alt=this._selectedImage.get("alt")||"",i):(this._selectedImage=null,!1)},_displayDialogue:function(t,o){var a,s;s=this.getDialogue({headerContent:M.util.get_string("sketchtitle","atto_sketch"),width:"100%",height:"100vh",focusAfterHide:o}),t.preventDefault(),s.after("visibleChange",function(){!1===s.getAttrs().visible&&setTimeout(function(){s.reset()},5)}),"100%px"!==s.width&&s.set("width","100%px"),"100vhpx"!==s.height&&s.set("height","100vhpx"),a=this._getFormContent(o),s.set("bodyContent",a),document.getElementById(n).src=i,s.centerDialogue(),s.show(),this.markUpdated();var d=!1;!1!==this.get("host").getSelection()&&(d=this._getSelectedImageProperties()),document.getElementById(n).addEventListener("load",function(){if(d){var t=new Image;t.crossOrigin="anonymous",t.src=d.src;var o=$("#"+n).contents()[0].defaultView.Layers,i={name:t.src.replace(/^.*[\\\/]/,""),type:"image",data:t,width:t.naturalWidth||d.width,height:t.naturalHeight||d.height,width_original:t.naturalWidth||d.width,height_original:t.naturalHeight||d.height};o.insert(i)}if(-1!==navigator.userAgent.indexOf("MSIE")||navigator.appVersion.indexOf("Trident/")>0){var a=document.documentElement.clientHeight;e.one(".moodle-dialogue-focused")&&e.one(".moodle-dialogue-focused").setStyle("height",a+"px"),e.one(".moodle-dialogue-focused .moodle-dialogue-bd")&&e.one(".moodle-dialogue-focused .moodle-dialogue-bd").setStyle("height",a-50+"px")}e.one(".moodle-dialogue-focused")&&(e.one(".moodle-dialogue-focused").setStyle("position","fixed"),e.one(".moodle-dialogue-focused").setStyle("z-index","999999"),e.one(".moodle-dialogue-focused").setStyle("top","0"),e.one(".moodle-dialogue-focused").setStyle("left","0")),e.one(".moodle-dialogue-focused .moodle-dialogue-bd")&&(e.one(".moodle-dialogue-focused .moodle-dialogue-bd").setStyle("height","calc(100% - 50px)"),e.one(".moodle-dialogue-focused .moodle-dialogue-bd").setStyle("padding","0")),e.one(".moodle-dialogue-focused").ancestor(".moodle-dialogue-base")&&e.one(".moodle-dialogue-focused").ancestor(".moodle-dialogue-base").setStyle("bottom","0"),e.one(".moodle-dialogue-focused").ancestor(".moodle-dialogue-fullscreen")&&e.one(".moodle-dialogue-focused").ancestor(".moodle-dialogue-fullscreen").setStyle("bottom","0")})},_getSketchWindow:function(e){var t;return e.contentWindow?e.contentWindow:e.window?e.window:(!t&&e.contentDocument&&(t=e.contentDocument),!t&&e.document&&(t=e.document),t&&t.defaultView?t.defaultView:t&&t.parentWindow?t.parentWindow:void 0)},_getFormContent:function(t){var o=e.Handlebars.compile('<iframe src="{{isource}}" id="{{iframeID}}" style="{{CSS.HGT}}{{CSS.WDT}}" scrolling="auto" frameborder="0"></iframe><div style="text-align:center"><button class="mdl-align {{CSS.INPUTSUBMIT}}" id="{{submitid}}" style="{{selectalign}}">{{get_string "insert" component}}</button></div>'),s=e.Node.create(o({elementid:this.get("host").get("elementid"),CSS:a,component:"atto_sketch",clickedicon:t,isource:i,iframeID:n,submitid:"submit"}));return this._form=s,this.get("storeinrepo")>0?this._form.one("."+a.INPUTSUBMIT).on("click",this._doInsert,this):this._form.one("."+a.INPUTSUBMIT).on("click",this._doInsertBase64,this),s},_doInsertBase64:function(e){e.preventDefault();var t='<img src="'+$("#"+n).contents()[0].getElementById("canvas_minipaint").toDataURL()+'" />';this.getDialogue({focusAfterHide:null}).hide(),this.editor.focus(),this.get("host").insertContentAtFocusPoint(t),this.markUpdated()}},{ATTRS:{storeinrepo:{value:0}}})},"@VERSION@",{requires:["moodle-editor_atto-plugin"]});